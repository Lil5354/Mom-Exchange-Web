@model B_M.Models.AdminImportUsersViewModel
@{
    ViewBag.Title = "Import người dùng từ Excel";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-card">
    <div class="admin-card-header">
        <h5><i class="fas fa-file-excel"></i> Import người dùng từ file Excel</h5>
        <div style="display: flex; gap: 10px;">
            <a href="@Url.Action("DownloadTemplate", "Admin", new { area = "Admin" })" class="btn-admin-secondary" style="text-decoration: none;">
                <i class="fas fa-download"></i> Tải template
            </a>
            <a href="@Url.Action("Users", "Admin", new { area = "Admin" })" class="btn-admin-secondary" style="text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>
    <div class="admin-card-body">
        @using (Html.BeginForm("ImportUsers", "Admin", new { area = "Admin" }, FormMethod.Post, new { @id = "importForm", @enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <!-- Left Column - File Upload -->
                <div>
                    <h6 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #ecf0f1;">
                        <i class="fas fa-upload"></i> Chọn file Excel
                    </h6>

                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 5px;">
                            File Excel <span style="color: #e74c3c;">*</span>
                        </label>
                        <div style="border: 2px dashed #3498db; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
                            <p style="margin: 0; color: #2c3e50; font-weight: 600;">Kéo thả file Excel vào đây</p>
                            <p style="margin: 5px 0; color: #7f8c8d; font-size: 14px;">hoặc</p>
                            <input type="file" name="ExcelFile" id="excelFile" accept=".xlsx,.xls" 
                                   style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;" />
                            <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 12px;">
                                Chấp nhận file .xlsx, .xls (tối đa 10MB)
                            </p>
                        </div>
                        @Html.ValidationMessageFor(m => m.ExcelFile, "", new { @class = "text-danger", @style = "font-size: 12px; margin-top: 5px;" })
                    </div>

                    <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h6 style="color: #0c5460; margin: 0 0 10px 0; font-size: 14px;">
                            <i class="fas fa-info-circle"></i> Hướng dẫn sử dụng
                        </h6>
                        <ul style="margin: 0; padding-left: 20px; color: #0c5460; font-size: 13px;">
                            <li>Tải template Excel để biết định dạng chuẩn</li>
                            <li>Cột A: Email (bắt buộc)</li>
                            <li>Cột B: Tên đăng nhập (tùy chọn)</li>
                            <li>Cột C: Họ và tên (bắt buộc)</li>
                            <li>Cột D: Số điện thoại (tùy chọn)</li>
                            <li>Cột E: Địa chỉ (tùy chọn)</li>
                            <li>Cột F: Vai trò (1=Admin, 2=Mom, 3=Brand)</li>
                        </ul>
                    </div>
                </div>

                <!-- Right Column - Import Settings -->
                <div>
                    <h6 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 8px; border-bottom: 2px solid #ecf0f1;">
                        <i class="fas fa-cog"></i> Cài đặt import
                    </h6>

                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; color: #2c3e50; display: block; margin-bottom: 5px;">
                            Vai trò mặc định <span style="color: #e74c3c;">*</span>
                        </label>
                        @Html.DropDownListFor(m => m.DefaultRole, new SelectList(new[]
                        {
                            new { Value = "1", Text = "Quản trị viên" },
                            new { Value = "2", Text = "Mẹ bỉm" },
                            new { Value = "3", Text = "Nhãn hàng" }
                        }, "Value", "Text", Model.DefaultRole), new { 
                            @class = "form-control", 
                            @style = "padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; font-size: 14px;"
                        })
                        @Html.ValidationMessageFor(m => m.DefaultRole, "", new { @class = "text-danger", @style = "font-size: 12px; margin-top: 5px;" })
                        <small style="color: #7f8c8d; font-size: 12px;">Vai trò sẽ được áp dụng cho các dòng không có thông tin vai trò</small>
                    </div>

                    <!-- Import Options -->
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: #2c3e50; margin-bottom: 15px;">Tùy chọn import</h6>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #2c3e50;">
                                @Html.CheckBoxFor(m => m.GenerateRandomPassword)
                                <span>Tự động tạo mật khẩu ngẫu nhiên</span>
                            </label>
                            <small style="color: #7f8c8d; font-size: 12px; margin-left: 25px;">Mật khẩu sẽ được tạo tự động cho từng tài khoản</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #2c3e50;">
                                @Html.CheckBoxFor(m => m.IsActive)
                                <span>Tài khoản hoạt động ngay</span>
                            </label>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #2c3e50;">
                                @Html.CheckBoxFor(m => m.SendEmailNotification)
                                <span>Gửi email thông báo</span>
                            </label>
                            <small style="color: #7f8c8d; font-size: 12px; margin-left: 25px;">Gửi thông tin tài khoản qua email</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #2c3e50;">
                                @Html.CheckBoxFor(m => m.SkipDuplicateEmails)
                                <span>Bỏ qua email trùng lặp</span>
                            </label>
                            <small style="color: #7f8c8d; font-size: 12px; margin-left: 25px;">Không tạo tài khoản nếu email đã tồn tại</small>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-weight: 500; color: #2c3e50;">
                                @Html.CheckBoxFor(m => m.SkipDuplicateUsernames)
                                <span>Bỏ qua username trùng lặp</span>
                            </label>
                            <small style="color: #7f8c8d; font-size: 12px; margin-left: 25px;">Xóa username nếu đã tồn tại</small>
                        </div>
                    </div>

                    <!-- File Info -->
                    <div id="fileInfo" style="display: none; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                        <h6 style="color: #495057; margin: 0 0 10px 0; font-size: 14px;">
                            <i class="fas fa-file"></i> Thông tin file
                        </h6>
                        <div id="fileDetails" style="color: #6c757d; font-size: 13px;"></div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
                <button type="submit" class="btn-admin" id="importBtn" style="padding: 15px 40px; font-size: 16px;" disabled>
                    <i class="fas fa-file-import"></i> Bắt đầu import
                </button>
                <a href="@Url.Action("Users", "Admin", new { area = "Admin" })" class="btn-admin-secondary" style="padding: 15px 40px; font-size: 16px; text-decoration: none; margin-left: 15px;">
                    <i class="fas fa-times"></i> Hủy bỏ
                </a>
            </div>
        }
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // File upload handling
            $('#excelFile').on('change', function() {
                var file = this.files[0];
                if (file) {
                    var fileSize = (file.size / 1024 / 1024).toFixed(2);
                    var fileName = file.name;
                    var fileType = fileName.split('.').pop().toLowerCase();
                    
                    // Validate file type
                    if (!['xlsx', 'xls'].includes(fileType)) {
                        alert('Chỉ chấp nhận file Excel (.xlsx, .xls)');
                        $(this).val('');
                        $('#fileInfo').hide();
                        $('#importBtn').prop('disabled', true);
                        return;
                    }
                    
                    // Validate file size
                    if (file.size > 10 * 1024 * 1024) {
                        alert('File quá lớn. Kích thước tối đa là 10MB');
                        $(this).val('');
                        $('#fileInfo').hide();
                        $('#importBtn').prop('disabled', true);
                        return;
                    }
                    
                    // Show file info
                    $('#fileDetails').html(`
                        <div><strong>Tên file:</strong> ${fileName}</div>
                        <div><strong>Kích thước:</strong> ${fileSize} MB</div>
                        <div><strong>Loại file:</strong> ${fileType.toUpperCase()}</div>
                    `);
                    $('#fileInfo').show();
                    $('#importBtn').prop('disabled', false);
                } else {
                    $('#fileInfo').hide();
                    $('#importBtn').prop('disabled', true);
                }
            });

            // Drag and drop functionality
            var dropZone = $('.admin-card-body');
            
            dropZone.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('drag-over');
            });
            
            dropZone.on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('drag-over');
            });
            
            dropZone.on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('drag-over');
                
                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    $('#excelFile')[0].files = files;
                    $('#excelFile').trigger('change');
                }
            });

            // Form submission
            $('#importForm').on('submit', function(e) {
                var importBtn = $('#importBtn');
                
                // Disable button and show loading
                importBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang import...');
                
                // Re-enable button after 30 seconds (in case of error)
                setTimeout(function() {
                    importBtn.prop('disabled', false).html('<i class="fas fa-file-import"></i> Bắt đầu import');
                }, 30000);
            });
        });
    </script>

    <style>
        .drag-over {
            background-color: #e3f2fd !important;
            border-color: #2196f3 !important;
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        
        .form-control.is-valid {
            border-color: #28a745;
        }
    </style>
}


